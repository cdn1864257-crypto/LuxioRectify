Voici le rapporrt de securit√© que tu as pr√©c√©demment fait. J'aimerais precis√© que dans render, variable env. est stock√© les cl√©s suivants:


Key	Value
Key
BACKEND_URL
Value
https://api.luxiomarket.shop

Key
CLIENT_URL
Value
https://luxiomarket.shop

Key
CLOUDINARY_URL
Value
‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢

Key
COOKIE_DOMAIN
Value
luxiomarket.shop

Key
CSRF_SECRET
Value
‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢


Key
ENCRYPTION_KEY
Value
‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢

Key
FRONTEND_URL
Value
https://luxiomarket.shop

Key
JWT_SECRET
Value
‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢


Key
MONGODB_URI
Value
mongodb+srv://replitprojet97_db_user:0DOT8bj0L29t34eV@cluster0.7fbxu65.mongodb.net/Luxio_market?retryWrites=true&w=majority&appName=Cluster0

Key
NODE_ENV
Value
production

Key
OXAPAY_API_KEY
Value
‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢

Key
PORT
Value
10000

Key
RESET_PASSWORD_URL
Value
https://luxiomarket.shop/reset-password

Key
RESET_TOKEN_TTL_MINUTES
Value
60

Key
SENDGRID_API_KEY
Value
‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢ ‚Ä¢

Key
SENDGRID_FROM_EMAIL
Value
support@luxiomarket.shop

Key
SESSION_SECRET
Value
ESkdsCDjxtqwrpAg9XOiDppQlBHNUmYaMX9eXat3eNWvjGfnlhMmfTyUshf09EBRCFWPVHlcGqt9bRJxCQv0hhF5


En fonction, tu me diras ce qu'il reste √† faire suite √† l'analyse faite pr√©c√©demment donc une copie ci-dessous:




Excellent, j'ai maintenant une vue compl√®te de votre infrastructure de s√©curit√©. Voici mon analyse de s√©curit√© d√©taill√©e :
üî¥ FAILLES CRITIQUES
1. Email Admin Expos√© dans le Code Source (CRITIQUE)

Fichiers concern√©s: utils/admin-auth.ts, api/upload/index.ts, api/products/*.ts, api/admin/*.ts (7+ fichiers)

Probl√®me:

const ADMIN_EMAILS = [
  'support@luxiomarket.shop',
];

Risque:

    Votre email admin est visible publiquement sur GitHub/Vercel/Render
    Un attaquant conna√Æt exactement le compte √† cibler pour le phishing
    Facilite les attaques par force brute sur ce compte sp√©cifique

Impact:

    Attaques cibl√©es sur le compte admin
    Phishing personnalis√©
    Ing√©nierie sociale facilit√©e

Solution recommand√©e:

// Utiliser une variable d'environnement
const ADMIN_EMAILS = (process.env.ADMIN_EMAILS || '').split(',').map(e => e.trim());

Puis dans Render:

ADMIN_EMAILS=support@luxiomarket.shop,admin2@luxiomarket.shop

2. Logs Verbeux en Production (CRITIQUE)

Fichiers: api/payment/oxapay-webhook.ts, api/payment/stripe-webhook.ts, etc.

Probl√®me:

console.log('[OxaPay Webhook] Received webhook:', JSON.stringify(req.body, null, 2));
console.log(`[Stripe Webhook] Payment succeeded: ${paymentIntent.id}`);

Risque:

    Donn√©es sensibles (montants, emails, IDs) logg√©es en clair
    Accessibles via les logs Render si mal configur√©s
    Peuvent fuiter des informations business

Solution:

// Seulement en d√©veloppement
if (process.env.NODE_ENV !== 'production') {
  console.log('[OxaPay Webhook] Received webhook:', JSON.stringify(req.body, null, 2));
}
// En production, logger uniquement les √©v√©nements importants sans donn√©es sensibles
console.log(`[OxaPay Webhook] Event processed: ${trackId} - Status: ${status}`);

3. Encryption Fallback Dangereux (√âLEV√â)

Fichier: utils/encryption.ts

Probl√®me:

const key: string = ENCRYPTION_KEY || 'dev-only-key-please-set-encryption-key-in-production';

Risque:

    Si ENCRYPTION_KEY n'est pas configur√©e en production, utilise une cl√© connue publiquement
    Tous les codes PCS/Transcash seraient chiffr√©s avec cette cl√© publique
    Un attaquant ayant acc√®s √† la DB peut d√©chiffrer tous les codes

Solution:

const ENCRYPTION_KEY = process.env.ENCRYPTION_KEY;

if (!ENCRYPTION_KEY) {
  throw new Error('‚ö†Ô∏è CRITICAL: ENCRYPTION_KEY must be set in production!');
}

const key: string = ENCRYPTION_KEY;

üü† FAILLES √âLEV√âES
4. Upload sans Validation de Fichiers (√âLEV√â)

Fichier: api/upload/index.ts

Probl√®me:

    Aucune validation du type MIME
    Aucune limite de taille de fichier
    Aucune v√©rification d'extension
    Upload direct vers Cloudinary sans filtrage

Risque:

    Admin compromis peut uploader :
        Binaires malveillants
        Scripts HTML/JS pour defacement
        Fichiers √©normes (DoS)
        Ex√©cutables

Solution:

// Dans api/upload/index.ts
const ALLOWED_MIME_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

// Apr√®s parsing du form
if (!imageFile) {
  return res.status(400).json({ error: 'Aucune image fournie' });
}

// V√©rifications de s√©curit√©
const file = imageFile as File;
if (!ALLOWED_MIME_TYPES.includes(file.mimetype || '')) {
  return res.status(400).json({ 
    error: 'Type de fichier non autoris√©. Formats accept√©s: JPG, PNG, WebP, GIF' 
  });
}

if (file.size > MAX_FILE_SIZE) {
  return res.status(400).json({ 
    error: `Fichier trop volumineux. Taille maximale: ${MAX_FILE_SIZE / 1024 / 1024}MB` 
  });
}

// Upload avec validation Cloudinary
const result = await cloudinary.uploader.upload(filePath, {
  folder: 'luxio-products',
  resource_type: 'image',
  allowed_formats: ['jpg', 'png', 'webp', 'gif'],
  transformation: [
    { width: 2000, height: 2000, crop: 'limit' } // Limite r√©solution
  ]
});

5. Configuration CORS Permissive en Dev (MOYEN-√âLEV√â)

Fichier: server/index-render.ts

Probl√®me:

} else if (!isProduction) {
  // Autoriser tout en dev uniquement
  res.header('Access-Control-Allow-Origin', origin || '*');
  res.header('Access-Control-Allow-Credentials', 'true');
}

Risque:

    Si NODE_ENV n'est pas correctement configur√© en production, CORS est ouvert √† tous
    Permet des attaques CSRF cross-origin
    Facilite le vol de cookies/tokens

Solution:

// Plus restrictif en dev aussi
} else if (!isProduction) {
  // Lister explicitement les origines dev autoris√©es
  if (origin && developmentOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
    res.header('Access-Control-Allow-Credentials', 'true');
  }
  // Pas de wildcard '*' avec credentials
}

6. Pas de Rate Limiting sur les Webhooks (MOYEN)

Fichiers: api/payment/oxapay-webhook.ts, api/payment/stripe-webhook.ts

Probl√®me:

    Pas de limite de requ√™tes sur les webhooks
    Un attaquant peut spammer des webhooks pour surcharger la DB

Solution:

// Dans server/index-render.ts
import rateLimit from 'express-rate-limit';

const webhookLimiter = rateLimit({
  windowMs: 1 * 60 * 1000, // 1 minute
  max: 100, // 100 requ√™tes par minute par IP
  message: 'Trop de requ√™tes webhook, veuillez r√©essayer plus tard',
  standardHeaders: true,
  legacyHeaders: false,
});

// Appliquer aux webhooks
app.post('/api/payment/oxapay-webhook', webhookLimiter, convertVercelHandler(oxapayWebhookHandler));
app.post('/api/payment/stripe-webhook', webhookLimiter, convertVercelHandler(stripeWebhookHandler));

üü° FAILLES MOYENNES
7. Session Secret par D√©faut Faible (MOYEN)

Fichier: server/index-render.ts:187

Probl√®me:

secret: process.env.SESSION_SECRET || process.env.JWT_SECRET || 'default-secret-change-in-production',

Solution: S'assurer que SESSION_SECRET est toujours configur√© en production
8. Pas de Validation Zod Syst√©matique (MOYEN)

Probl√®me: Certains endpoints ne valident pas rigoureusement les inputs utilisateur

Solution: Ajouter Zod validation sur tous les endpoints qui acceptent des donn√©es utilisateur
‚úÖ Points Positifs

    ‚úÖ JWT bien impl√©ment√© avec expiration de 7 jours
    ‚úÖ CSRF correctement configur√© avec exemptions appropri√©es
    ‚úÖ HMAC signature v√©rifi√©e sur webhook OxaPay
    ‚úÖ Stripe signature v√©rifi√©e avec constructEvent
    ‚úÖ Helmet configur√© avec HSTS, CSP, etc.
    ‚úÖ HTTPS forc√© en production
    ‚úÖ Cookies httpOnly et secure
    ‚úÖ D√©duplication des webhooks avec cache
    ‚úÖ Rate limiting sur auth et g√©n√©ral
    ‚úÖ Bcrypt pour les mots de passe

üìã Plan d'Action Prioritaire
üî¥ URGENT (Imm√©diat)

    D√©placer ADMIN_EMAILS vers variables d'environnement
    D√©sactiver les logs verbeux en production
    Ajouter throw error si ENCRYPTION_KEY manquant

üü† Important (Cette semaine)

    Ajouter validation de fichiers sur upload
    Corriger CORS dev pour √™tre plus restrictif
    Ajouter rate limiting sur webhooks

üü° Am√©liorations (Ce mois)

    Configurer SESSION_SECRET d√©di√©
    Ajouter Zod validation partout
    Audit de s√©curit√© complet avec outil externe




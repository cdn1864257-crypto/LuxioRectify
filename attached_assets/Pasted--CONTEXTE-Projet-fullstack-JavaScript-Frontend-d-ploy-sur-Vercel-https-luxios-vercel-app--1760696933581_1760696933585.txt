ğŸš¨ CONTEXTE :

Projet fullstack JavaScript

Frontend dÃ©ployÃ© sur Vercel â†’ https://luxios.vercel.app

Backend hÃ©bergÃ© sur Render â†’ https://luxio.onrender.com

Sessions gÃ©rÃ©es avec MongoDB Atlas

Panier stockÃ© en localStorage cÃ´tÃ© client

Paiements disponibles :

Crypto via NOWPayments

Paiement par ticket Transcash / PCS

Virement bancaire



Depuis la mise en place de la sÃ©curitÃ© CSRF, plusieurs dysfonctionnements sont apparus.
Lis le fichier sÃ©curitÃ©.md pour tâ€™assurer que la configuration actuelle est cohÃ©rente, puis applique les correctifs suivants.




---

âš™ï¸ TÃ‚CHES Ã€ EFFECTUER (PAR PRIORITÃ‰)


---

ğŸ§© 1. Corriger le problÃ¨me de CSRF / CORS / Cookies

Les requÃªtes de paiement Ã©chouent avec Failed to fetch.
Ceci provient dâ€™un blocage CORS combinÃ© Ã  une mauvaise gestion des cookies et tokens CSRF entre Vercel (front) et Render (back).

âœ… Ã€ faire dans le backend (Express / app.js) :

import cors from "cors";
import session from "express-session";
import connectMongo from "connect-mongodb-session";
import csrf from "csurf";
import cookieParser from "cookie-parser";

const MongoDBStore = connectMongo(session);
const store = new MongoDBStore({
  uri: process.env.MONGO_URL, // MongoDB Atlas
  collection: "sessions",
});

app.use(cookieParser());

// âœ… Autoriser les requÃªtes du domaine Vercel
app.use(
  cors({
    origin: "https://luxios.vercel.app",
    credentials: true,
    methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    allowedHeaders: ["Content-Type", "Authorization", "X-CSRF-Token"],
  })
);

// âœ… Configuration de la session MongoDB
app.use(
  session({
    secret: process.env.SESSION_SECRET,
    resave: false,
    saveUninitialized: false,
    store: store,
    cookie: {
      httpOnly: true,
      secure: true,
      sameSite: "None",
      maxAge: 24 * 60 * 60 * 1000,
    },
  })
);

// âœ… CSRF â€” exclure les routes de paiement et webhooks
const csrfProtection = csrf();

app.use((req, res, next) => {
  const exemptRoutes = [
    /^\/api\/payment\/nowpayments/,
    /^\/api\/payment\/transcash/,
    /^\/api\/payment\/webhook/,
    /^\/api\/payment\/bank/,
  ];
  if (exemptRoutes.some((rx) => rx.test(req.path))) return next();
  return csrfProtection(req, res, next);
});

// âœ… Route pour fournir le token CSRF au frontend
app.get("/api/csrf-token", (req, res) => {
  res.json({ csrfToken: req.csrfToken() });
});

âœ… CÃ´tÃ© frontend (Vercel)
Toujours inclure les cookies et le token CSRF avant les requÃªtes POST :

const resToken = await fetch("https://luxio.onrender.com/api/csrf-token", {
  credentials: "include",
});
const { csrfToken } = await resToken.json();

await fetch("https://luxio.onrender.com/api/payment/init", {
  method: "POST",
  credentials: "include",
  headers: {
    "Content-Type": "application/json",
    "X-CSRF-Token": csrfToken,
  },
  body: JSON.stringify(paymentData),
});


---

ğŸ’¸ 2. Paiements (Crypto, Transcash/PCS, Virement)

âœ… a. Crypto â€” NOWPayments

VÃ©rifier que lâ€™appel API Ã  NOWPayments se fait depuis le backend (Render), et non directement depuis le front.

Exclure les routes de crÃ©ation et de webhook du CSRF.

VÃ©rifier que process.env.NOWPAYMENTS_API_KEY est bien configurÃ©e sur Render.


âœ… b. Transcash / PCS

VÃ©rifier que les boutons â€œPayâ€ et les fonctions associÃ©es (handlers JS) ne sont pas dÃ©sactivÃ©s.

Inspecter la console JS : sâ€™il y a une erreur avant exÃ©cution, corriger le script.

Sâ€™assurer que le bouton nâ€™est pas recouvert par un overlay invisible (z-index et pointer-events).


âœ… c. Virement bancaire

Le bouton â€œYes, I proceed with the transferâ€ doit dÃ©clencher un onClick ou une action dÃ©finie. Exemple :


<button
  type="button"
  onClick={handleConfirmTransfer}
  className="btn-primary"
>
  Yes, I proceed with the transfer
</button>

VÃ©rifier que handleConfirmTransfer() effectue bien la requÃªte POST vers /api/payment/bank/init.



---

ğŸ“± 3. Corriger le scroll bloquÃ© sur mobile pour le sÃ©lecteur de langues

ProblÃ¨me : impossible de dÃ©filer la liste des langues sur petits Ã©crans.

âœ… Correctif CSS Ã  appliquer :

.lang-dropdown {
  max-height: 40vh;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

VÃ©rifier Ã©galement quâ€™aucun overflow: hidden permanent nâ€™est appliquÃ© sur <body> ou .root.


---

ğŸ“² 4. AmÃ©liorer lâ€™affichage du virement bancaire sur mobile

Rendre la section responsive et Ã©lÃ©gante sur petit Ã©cran.

âœ… Exemple CSS :

.bank-transfer-modal .content {
  width: 90%;
  max-width: 500px;
  margin: 1.5rem auto;
  padding: 1rem;
  border-radius: 12px;
}

@media (max-width: 420px) {
  .bank-transfer-modal .content {
    width: 96%;
    padding: 0.75rem;
    font-size: 14px;
  }

  .bank-transfer-modal .bank-details {
    display: block;
    white-space: normal;
    word-break: break-word;
  }
}


---

ğŸ§¹ 5. DÃ©connexion â†’ suppression automatique du panier

Actuellement, les produits restent en localStorage aprÃ¨s logout.

âœ… Ã€ faire cÃ´tÃ© frontend : Lors du logout :

await fetch("https://luxio.onrender.com/api/auth/logout", {
  method: "POST",
  credentials: "include",
});
localStorage.removeItem("cart");
window.location.href = "/";

âœ… Et cÃ´tÃ© backend :

app.post("/api/auth/logout", (req, res) => {
  req.session.destroy(() => {
    res.clearCookie("connect.sid", { sameSite: "None", secure: true });
    res.json({ ok: true });
  });
});


---

ğŸ§ª 6. Tests Ã  effectuer avant validation

1. Depuis un mobile (petit Ã©cran), vÃ©rifier :

DÃ©filement des langues.

Affichage du virement bancaire.



2. Tester les trois paiements :

Crypto (NOWPayments)

Transcash / PCS

Virement bancaire
âœ… Tous doivent dÃ©sormais dÃ©clencher leur action sans erreur Failed to fetch.



3. DÃ©connexion â†’ le panier doit Ãªtre vide.




---

ğŸ¯ OBJECTIF FINAL

> Obtenir un site parfaitement fonctionnel et responsive oÃ¹ :

Les paiements (Crypto, Transcash, Virement) fonctionnent sans erreur.

Le scroll du sÃ©lecteur de langues est fluide sur mobile.

Le virement bancaire est bien mis en page sur petit Ã©cran.

La dÃ©connexion vide le panier.

Les protections CSRF restent actives sans bloquer les paiements.

